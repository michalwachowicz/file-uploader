<% if (typeof isRoot !== 'undefined' && isRoot) { %>
  <ul>
    <li>
      <details open>
        <summary>
          <a href="/"><%= user.username %>'s drive</a>
        </summary>

        <% if (allFolders && allFolders.length > 0) { %>
          <ul>
            <% for (const folder of allFolders) { %>
              <%- include('folder-tree', {
                  isRoot: false,
                  node: folder,
                  folderPath: typeof folderPath !== 'undefined' ? folderPath : [],
                }
              ) %>
            <% } %>
          </ul>
        <% } %>
      </details>
    </li>
  </ul>

  <% if (folderPath && folderPath.length > 0) { %>
    <div id="folder-data" data-folder-path='<%- JSON.stringify(folderPath) %>' hidden></div>
  <% } %>

  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('folder-data');
      if (!el) return;

      const folderPath = JSON.parse(el.dataset.folderPath || '[]');

      folderPath.forEach(folderId => {
        const details = document.querySelector(`details[data-folder-id="${folderId}"]`);
        if (details) details.open = true;
      });

      el.remove();
    });
  </script>
<% } else { %>
  <li>
    <% if (node.subfolders && node.subfolders.length) { %>
      <details data-folder-id="<%= node.id %>">
        <summary>
          <a href="/folders/<%= node.id %>"><%= node.name %></a>
        </summary>

        <ul>
          <% for (const child of node.subfolders) { %>
            <%- include('folder-tree', {
                isRoot: false,
                node: child,
                folderPath: typeof folderPath !== 'undefined' ? folderPath : [],
              }
            ) %>
          <% } %>
        </ul>
      </details>
    <% } else { %>
      <a href="/folders/<%= node.id %>"><%= node.name %></a>
    <% } %>
  </li>
<% } %>
